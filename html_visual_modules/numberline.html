<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Number Line Visual Module</title>
    <link rel="stylesheet" href="shared-styles.css">
    <style>
        .numberline-container {
            position: relative;
            width: 100%;
            max-width: 600px;
        }

        .numberline-canvas {
            width: 100%;
            height: 120px;
            border: 2px solid #00ff00;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.8);
        }

        .numberline-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .numberline-info {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 6px;
            border: 1px solid #00ff00;
        }

        .numberline-step {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .numberline-highlight {
            animation: numberline-pulse 1s infinite;
        }

        @keyframes numberline-pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="math-visual-container">
        <div class="math-problem-statement" id="problemStatement">
            Loading problem...
        </div>
        
        <div class="numberline-container">
            <canvas id="numberlineCanvas" class="numberline-canvas"></canvas>
        </div>

        <div class="numberline-controls">
            <button id="showHintBtn" class="math-btn">Show Hint</button>
            <button id="animateBtn" class="math-btn">Animate</button>
            <button id="resetBtn" class="math-btn">Reset</button>
        </div>

        <div class="math-controls">
            <input type="number" id="answerInput" class="math-answer-input" placeholder="Enter your answer">
            <button id="submitBtn" class="math-btn">Submit</button>
        </div>

        <div id="feedbackContainer"></div>
        <div id="infoContainer" class="numberline-info" style="display: none;"></div>
    </div>

    <script src="shared-utils.js"></script>
    <script>
        class NumberLineVisualizer {
            constructor(containerId = 'numberlineCanvas') {
                this.canvas = document.getElementById(containerId);
                this.ctx = MathVisualUtils.getCanvasContext(this.canvas);
                this.problemData = null;
                this.animationId = null;
                this.currentStep = 0;
                this.isAnimating = false;
                
                this.setupEventListeners();
                this.setupCanvas();
            }

            setupEventListeners() {
                document.getElementById('showHintBtn').addEventListener('click', () => this.showHint());
                document.getElementById('animateBtn').addEventListener('click', () => this.animateProblem());
                document.getElementById('resetBtn').addEventListener('click', () => this.resetVisualization());
                document.getElementById('submitBtn').addEventListener('click', () => this.submitAnswer());
                
                document.getElementById('answerInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.submitAnswer();
                    }
                });
            }

            setupCanvas() {
                // Set canvas size based on container
                const rect = this.canvas.getBoundingClientRect();
                this.canvas.width = rect.width * window.devicePixelRatio;
                this.canvas.height = rect.height * window.devicePixelRatio;
                this.ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            }

            loadProblem(problemData) {
                this.problemData = problemData;
                this.currentStep = 0;
                this.isAnimating = false;
                
                document.getElementById('problemStatement').textContent = problemData.problem_statement;
                this.drawNumberLine();
                this.showInfo();
            }

            drawNumberLine() {
                if (!this.problemData) return;

                const canvas = this.canvas;
                const ctx = this.ctx;
                const width = canvas.width / window.devicePixelRatio;
                const height = canvas.height / window.devicePixelRatio;

                // Clear canvas
                ctx.clearRect(0, 0, width, height);

                // Draw grid
                MathVisualUtils.drawGrid(ctx, width, height, 20, '#00ff00', 0.1);

                // Calculate number line parameters
                const padding = 40;
                const lineY = height / 2;
                const lineStartX = padding;
                const lineEndX = width - padding;
                const lineLength = lineEndX - lineStartX;

                // Calculate scale
                const minVal = this.problemData.range.min;
                const maxVal = this.problemData.range.max;
                const range = maxVal - minVal;
                const scale = lineLength / range;

                // Draw number line
                ctx.save();
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(lineStartX, lineY);
                ctx.lineTo(lineEndX, lineY);
                ctx.stroke();

                // Draw tick marks and labels
                const tickPositions = this.problemData.tick_positions;
                for (const tick of tickPositions) {
                    const x = lineStartX + (tick - minVal) * scale;
                    
                    // Draw tick mark
                    ctx.beginPath();
                    ctx.moveTo(x, lineY - 10);
                    ctx.lineTo(x, lineY + 10);
                    ctx.stroke();

                    // Draw label
                    MathVisualUtils.drawGlowText(ctx, tick.toString(), x, lineY + 25, 12);
                }

                // Draw start position
                const startX = lineStartX + (this.problemData.start_position - minVal) * scale;
                this.drawPositionMarker(startX, lineY, '#00ff00', 'START');

                // Draw result position
                const resultX = lineStartX + (this.problemData.result_position - minVal) * scale;
                this.drawPositionMarker(resultX, lineY, '#ffff00', 'RESULT');

                ctx.restore();
            }

            drawPositionMarker(x, y, color, label) {
                const ctx = this.ctx;
                
                ctx.save();
                ctx.fillStyle = color;
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                
                // Draw circle
                ctx.beginPath();
                ctx.arc(x, y, 8, 0, 2 * Math.PI);
                ctx.fill();
                ctx.stroke();
                
                // Draw label
                MathVisualUtils.drawGlowText(ctx, label, x, y - 20, 10, color);
                
                ctx.restore();
            }

            animateProblem() {
                if (!this.problemData || this.isAnimating) return;

                this.isAnimating = true;
                this.currentStep = 0;
                document.getElementById('animateBtn').textContent = 'Animating...';
                document.getElementById('animateBtn').disabled = true;

                this.animateMovement();
            }

            animateMovement() {
                if (!this.isAnimating) return;

                const canvas = this.canvas;
                const width = canvas.width / window.devicePixelRatio;
                const height = canvas.height / window.devicePixelRatio;
                const padding = 40;
                const lineY = height / 2;
                const lineStartX = padding;
                const lineLength = (width - 2 * padding);

                const minVal = this.problemData.range.min;
                const maxVal = this.problemData.range.max;
                const range = maxVal - minVal;
                const scale = lineLength / range;

                const startX = lineStartX + (this.problemData.start_position - minVal) * scale;
                const endX = lineStartX + (this.problemData.result_position - minVal) * scale;

                let currentX = startX;
                const stepSize = (endX - startX) / 20;
                const stepDelay = 100;

                const animateStep = () => {
                    if (this.currentStep >= 20) {
                        this.isAnimating = false;
                        document.getElementById('animateBtn').textContent = 'Animate';
                        document.getElementById('animateBtn').disabled = false;
                        this.drawNumberLine();
                        return;
                    }

                    // Clear and redraw
                    this.drawNumberLine();

                    // Draw moving marker
                    const ctx = this.ctx;
                    ctx.save();
                    ctx.fillStyle = '#ff0000';
                    ctx.strokeStyle = '#ff0000';
                    ctx.lineWidth = 3;
                    
                    ctx.beginPath();
                    ctx.arc(currentX, lineY, 6, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.stroke();
                    
                    // Draw arrow showing direction
                    const arrowLength = 20;
                    const direction = this.problemData.operation === 'addition' ? 1 : -1;
                    const arrowEndX = currentX + (direction * arrowLength);
                    
                    MathVisualUtils.drawArrow(ctx, currentX, lineY - 15, arrowEndX, lineY - 15, '#ff0000', 2);
                    
                    ctx.restore();

                    currentX += stepSize;
                    this.currentStep++;

                    setTimeout(animateStep, stepDelay);
                };

                animateStep();
            }

            showHint() {
                if (!this.problemData) return;

                const hint = this.getHint();
                MathVisualUtils.showFeedback(
                    document.getElementById('feedbackContainer'),
                    hint,
                    'hint'
                );
            }

            getHint() {
                if (this.problemData.operation === 'addition') {
                    return `Start at ${this.problemData.start_position} and move ${this.problemData.change_amount} steps to the right`;
                } else {
                    return `Start at ${this.problemData.start_position} and move ${this.problemData.change_amount} steps to the left`;
                }
            }

            submitAnswer() {
                const input = document.getElementById('answerInput');
                const userAnswer = parseInt(input.value);

                if (!MathVisualUtils.validateNumericInput(input.value)) {
                    MathVisualUtils.showFeedback(
                        document.getElementById('feedbackContainer'),
                        'Please enter a valid number',
                        'incorrect'
                    );
                    return;
                }

                const isCorrect = userAnswer === this.problemData.result_position;
                
                if (isCorrect) {
                    MathVisualUtils.showFeedback(
                        document.getElementById('feedbackContainer'),
                        'Correct! Well done!',
                        'correct'
                    );
                    MathVisualUtils.createPulseEffect(document.getElementById('numberlineCanvas'));
                } else {
                    MathVisualUtils.showFeedback(
                        document.getElementById('feedbackContainer'),
                        `Incorrect. The answer is ${this.problemData.result_position}`,
                        'incorrect'
                    );
                }
            }

            showInfo() {
                const infoContainer = document.getElementById('infoContainer');
                infoContainer.innerHTML = `
                    <div class="numberline-step"><strong>Operation:</strong> ${this.problemData.operation}</div>
                    <div class="numberline-step"><strong>Start Position:</strong> ${this.problemData.start_position}</div>
                    <div class="numberline-step"><strong>Change Amount:</strong> ${this.problemData.change_amount}</div>
                    <div class="numberline-step"><strong>Result Position:</strong> ${this.problemData.result_position}</div>
                    <div class="numberline-step"><strong>Range:</strong> ${this.problemData.range.min} to ${this.problemData.range.max}</div>
                `;
                infoContainer.style.display = 'block';
            }

            resetVisualization() {
                this.isAnimating = false;
                this.currentStep = 0;
                document.getElementById('animateBtn').textContent = 'Animate';
                document.getElementById('animateBtn').disabled = false;
                document.getElementById('answerInput').value = '';
                
                // Clear feedback
                const feedbackContainer = document.getElementById('feedbackContainer');
                feedbackContainer.innerHTML = '';
                
                this.drawNumberLine();
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.numberLineVisualizer = new NumberLineVisualizer();
            
            // Example problem data (this would come from the Python backend)
            const exampleProblem = {
                type: "number_line",
                operation: "addition",
                orientation: "horizontal",
                range: { min: 0, max: 15 },
                tick_interval: 1,
                tick_positions: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],
                start_position: 5,
                change_amount: 7,
                result_position: 12,
                show_labels: true,
                highlight_result: true,
                problem_statement: "5 + 7 = ?"
            };
            
            window.numberLineVisualizer.loadProblem(exampleProblem);
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            if (window.numberLineVisualizer) {
                window.numberLineVisualizer.setupCanvas();
                window.numberLineVisualizer.drawNumberLine();
            }
        });
    </script>
</body>
</html>
